@page
@model ERSimulatorApp.Pages.LogsModel
@{
    ViewData["Title"] = "Log";
}

<div class="container-fluid h-100 py-4">
    <div class="row justify-content-center">
        <div class="col-lg-10 col-xl-8">
            <div class="logs-panel h-100 d-flex flex-column">
                <div class="logs-header d-flex justify-content-between align-items-center">
                    <div>
                        <h4 class="mb-1">
                            <i class="fas fa-clipboard-list me-2"></i>
                            Log
                        </h4>
                        <small class="text-white-50">
                            View the latest chat interactions captured by the simulator.
                        </small>
                    </div>
                    <div class="d-flex align-items-center gap-2">
                        <button class="btn btn-sm btn-light" id="refreshLogs">
                            <i class="fas fa-sync-alt me-1"></i> Refresh
                        </button>
                    </div>
                </div>

                <div class="logs-body" id="logsContainer">
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-history fa-3x mb-3" style="color: #94a3b8;"></i>
                        <p>Loading recent activity...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const logsContainer = document.getElementById('logsContainer');
        const refreshLogsButton = document.getElementById('refreshLogs');

        async function loadRecentLogs() {
            try {
                const response = await fetch(`${window.APP_BASE_PATH || ''}/api/chat/logs?count=20`);
                if (!response.ok) {
                    throw new Error('Failed to load logs');
                }

                const logs = await response.json();
                logsContainer.innerHTML = '';

                if (logs.length === 0) {
                    logsContainer.innerHTML = `
                        <div class="text-center text-muted py-5">
                            <i class="fas fa-history fa-3x mb-3" style="color: #94a3b8;"></i>
                            <p>No logs yet. Start chatting to see conversation history!</p>
                        </div>
                    `;
                    return;
                }

                logs.reverse().forEach(log => {
                    const logDiv = document.createElement('div');
                    logDiv.className = 'log-entry';

                    let responseTimeMs = 0;
                    if (typeof log.responseTime === 'string') {
                        const parts = log.responseTime.split(':');
                        if (parts.length === 3) {
                            const seconds = parseFloat(parts[2]);
                            responseTimeMs = (parseInt(parts[0]) * 3600 + parseInt(parts[1]) * 60 + seconds) * 1000;
                        } else {
                            responseTimeMs = parseFloat(log.responseTime) || 0;
                        }
                    } else {
                        responseTimeMs = log.responseTime || 0;
                    }

                    logDiv.innerHTML = `
                        <div class="log-meta">
                            <span><i class="fas fa-clock me-1"></i>${new Date(log.timestamp).toLocaleString()}</span>
                            <span class="log-response-time">${Math.round(responseTimeMs)}ms</span>
                        </div>
                        <div class="mb-2">
                            <i class="fas fa-user text-primary me-1"></i>
                            <strong>User:</strong><br>
                            <span class="text-muted">${log.userMessage.substring(0, 180)}${log.userMessage.length > 180 ? '...' : ''}</span>
                        </div>
                        <div>
                            <i class="fas fa-robot text-success me-1"></i>
                            <strong>AI:</strong><br>
                            <span class="text-muted">${log.aiResponse.substring(0, 180)}${log.aiResponse.length > 180 ? '...' : ''}</span>
                        </div>
                    `;
                    logsContainer.appendChild(logDiv);
                });
            } catch (error) {
                console.error('Error loading logs:', error);
                logsContainer.innerHTML = `
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-triangle-exclamation fa-3x mb-3 text-warning"></i>
                        <p>Unable to load recent activity right now.</p>
                        <p class="small">Please try refreshing.</p>
                    </div>
                `;
            }
        }

        refreshLogsButton.addEventListener('click', loadRecentLogs);
        loadRecentLogs();
    </script>
}







